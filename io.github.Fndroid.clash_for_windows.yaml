app-id: io.github.Fndroid.clash_for_windows
runtime: org.freedesktop.Platform
runtime-version: 21.08
base: org.electronjs.Electron2.BaseApp
base-version: 21.08
sdk: org.freedesktop.Sdk
separate-locales: false
command: migrate_checker.sh && cfw.sh ; pkill clash-linux

finish-args:
  - --share=network
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --persist=.config/clash
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --system-talk-name=org.freedesktop.login1

modules:
  - name: clash_for_windows
    buildsystem: simple
    build-commands:
      - install -Dm755 apply_extra /app/bin/
      - install -Dm755 cfw.sh /app/bin/
      - install -Dm644 io.github.Fndroid.clash_for_windows.png /app/share/icons/hicolor/256x256/apps/io.github.Fndroid.clash_for_windows.png
      - install -Dm644 io.github.Fndroid.clash_for_windows.desktop /app/share/applications/io.github.Fndroid.clash_for_windows.desktop
      - install -Dm644 io.github.Fndroid.clash_for_windows.appdata.xml /app/share/metainfo/io.github.Fndroid.clash_for_windows.appdata.xml

    sources:
      - type: extra-data
        filename: clash_for_windows.tar.gz
        url: https://github.com/Fndroid/clash_for_windows_pkg/releases/download/0.20.5/Clash.for.Windows-0.20.5-x64-linux.tar.gz
        sha256: df597d26b22fdd03fe252299afbb8ab73a7762e46a20eb9947adf94295d56de9
        size: 98474485
        x-checker-data:
          type: anitya
          project-id: 241851
          stable-only: true
          url-template: https://github.com/Fndroid/clash_for_windows_pkg/releases/download/$version/Clash.for.Windows-$version-x64-linux.tar.gz

      - type: script
        commands:
          - tar xf clash_for_windows.tar.gz
          - mv Clash\ for\ Windows-*-x64-linux clash_for_windows
          - rm -f clash_for_windows.tar.gz
        dest-filename: apply_extra

      - type: script
        commands:
          - export TMPDIR=$XDG_RUNTIME_DIR/app/$FLATPAK_ID
          - exec zypak-wrapper /app/extra/clash_for_windows/cfw "$@"
        dest-filename: cfw.sh

      - type: file
        path: io.github.Fndroid.clash_for_windows.desktop

      - type: file
        path: io.github.Fndroid.clash_for_windows.png

      - type: file
        path: io.github.Fndroid.clash_for_windows.appdata.xml
        
      - type: file
        path: migrate_checker.sh
        
      - type: file
        path: migrate_checker.desktop
